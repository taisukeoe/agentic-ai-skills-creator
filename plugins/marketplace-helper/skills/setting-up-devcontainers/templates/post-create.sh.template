#!/bin/bash
# Post-create script for Claude Code devcontainer
# Generated for: {{MARKETPLACE_NAME}}
set -e

CONFIG_DIR="$HOME/.claude"
WORKSPACE="/workspaces/{{PROJECT_DIR}}"

# Ensure Claude Code and Volta are in PATH
export VOLTA_HOME="$HOME/.volta"
export PATH="$VOLTA_HOME/bin:$HOME/.local/bin:$PATH"

echo "Setting up Claude Code devcontainer..."

# Ensure required directories have correct ownership (volumes may be owned by root initially)
# {{CODEX_DIR_LIST}} - If Codex enabled, "$HOME/.codex" is added to this list
for dir in "$CONFIG_DIR" "$HOME/.local/share/claude" "$HOME/.local/state"{{CODEX_DIR_LIST}}; do
    if [ -d "$dir" ]; then
        sudo chown -R "$(id -u):$(id -g)" "$dir"
    else
        sudo mkdir -p "$dir"
        sudo chown -R "$(id -u):$(id -g)" "$dir"
    fi
done

# Symlink ~/.claude.json to persist setup state inside the volume
# (Claude Code stores initial setup completion state in this file)
CLAUDE_JSON_IN_VOLUME="$CONFIG_DIR/.home-claude.json"
if [ -d "$HOME/.claude.json" ]; then
    # Remove if it's a directory (from failed volume mount)
    rm -rf "$HOME/.claude.json"
fi
if [ ! -L "$HOME/.claude.json" ]; then
    # Create valid empty JSON if not exists
    [ ! -f "$CLAUDE_JSON_IN_VOLUME" ] && echo '{}' > "$CLAUDE_JSON_IN_VOLUME"
    ln -sf "$CLAUDE_JSON_IN_VOLUME" "$HOME/.claude.json"
fi

# Claude Code is pre-installed in the Docker image

# Create shell aliases file in the volume (persists across rebuilds)
ALIASES_FILE="$CONFIG_DIR/.shell-aliases"
if [ ! -f "$ALIASES_FILE" ]; then
    cat > "$ALIASES_FILE" << 'ALIASES_EOF'
# Claude Code aliases (persisted in volume)
alias claude-y='claude --dangerously-skip-permissions'
{{CODEX_ALIASES}}
ALIASES_EOF
    echo "Shell aliases created: $ALIASES_FILE"
fi

# Generate settings.json with enabled plugins and permissions (only if not exists)
mkdir -p "$CONFIG_DIR"
if [ ! -f "$CONFIG_DIR/settings.json" ]; then
cat > "$CONFIG_DIR/settings.json" << 'SETTINGS_EOF'
{
  "enabledPlugins": {
{{ENABLED_PLUGINS}}
  },
  "permissions": {
    "allow": [
{{ALLOWED_SKILLS}}
    ]
  }
}
SETTINGS_EOF
  echo "Settings configured."
else
  echo "Settings already exist, skipping."
fi

# Register marketplace and install plugins (only if Claude is already set up)
# Skip if not set up yet - user needs to run 'claude' first to complete setup
if [ -s "$CLAUDE_JSON_IN_VOLUME" ] && [ "$(cat "$CLAUDE_JSON_IN_VOLUME")" != "{}" ]; then
    echo "Registering marketplace..."
    claude plugin marketplace add "$WORKSPACE" || true

    echo "Installing plugins..."
{{PLUGIN_INSTALL_COMMANDS}}
else
    echo "Claude not yet set up. Run 'claude' to complete setup, then run:"
    echo "  bash .devcontainer/reinstall-marketplace.sh"
fi

{{CODEX_SETUP_BLOCK}}

echo ""
echo "======================================"
echo "{{DEVCONTAINER_READY_MESSAGE}}"
echo ""
echo "Run 'claude' to complete initial setup (first time only)."
echo "Your credentials will persist across container rebuilds."
echo ""
echo "Aliases available (after shell restart):"
echo "  claude-y  - claude --dangerously-skip-permissions"
{{CODEX_ALIAS_ECHO}}
echo "======================================"
